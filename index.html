<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è³‡é‡‘é‹ç”¨æˆ°æƒ…å®¤ (è¨˜æ†¶å¢å¼·ç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); padding: 1.5rem; height: 100%; display: flex; flex-direction: column; }
        .input-row { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
        .btn-add { background-color: #ecfdf5; color: #059669; border: 1px dashed #059669; width: 100%; padding: 0.5rem; border-radius: 0.375rem; transition: 0.2s; font-size: 0.9rem; }
        .btn-add:hover { background-color: #d1fae5; }
        .btn-del { color: #ef4444; cursor: pointer; padding: 0 5px; font-weight: bold; }
        .section-header { border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center; }
        input, select { border: 1px solid #d1d5db; padding: 0.4rem; border-radius: 0.25rem; font-size: 0.9rem; transition: border 0.2s; }
        input:focus { border-color: #3b82f6; outline: none; }
        .divider-bonus { margin-top: auto; border-top: 2px dashed #e5e7eb; padding-top: 1rem; margin-bottom: 1rem; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .etf-table { width: 100%; text-align: right; border-collapse: collapse; font-size: 0.85rem; }
        .etf-table th { background: #f1f5f9; padding: 8px; text-align: center; color: #475569; font-weight: bold; border-bottom: 2px solid #cbd5e1; position: sticky; top: 0; }
        .etf-table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
        .etf-table tr:hover { background-color: #f8fafc; }

        /* å„²å­˜æç¤º */
        .save-toast { position: fixed; bottom: 20px; right: 20px; background: #334155; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100; font-size: 0.8rem; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .save-toast.show { opacity: 1; }
    </style>
</head>
<body>

<div id="app" class="p-4 max-w-[1400px] mx-auto pb-20 relative">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
        <h1 class="text-3xl font-bold text-slate-700">ğŸ“Š å®¶åº­è³‡é‡‘é‹ç”¨æˆ°æƒ…å®¤ <span class="text-sm font-normal text-slate-500 block sm:inline">è‡ªå‹•å„²å­˜ç‰ˆ</span></h1>
        <button @click="resetData" class="text-sm bg-red-50 hover:bg-red-100 text-red-600 px-4 py-2 rounded-lg border border-red-200 transition">
            ğŸ”„ é‡ç½®æ‰€æœ‰è³‡æ–™
        </button>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card border-t-4 border-blue-500">
            <div class="section-header">
                <h2 class="text-xl font-bold text-blue-700">ğŸ‘¨ ç”·ç”Ÿè²¡å‹™</h2>
            </div>
            <div class="space-y-4 mb-4">
                <div><label class="block text-sm font-bold text-gray-600">æœˆè–ªè³‡</label><input type="number" v-model.number="male.salary" class="w-full"></div>
                <div><label class="block text-sm font-bold text-gray-600">æ’¥å…¥å…±åŒå¸³æˆ¶</label><input type="number" v-model.number="male.contrib" class="w-full bg-blue-50"></div>
                <div>
                    <h3 class="font-bold text-gray-600 text-sm mb-2">å€‹äººé–‹éŠ·ç´°é …</h3>
                    <div v-for="(item, index) in male.expenses" :key="index" class="input-row">
                        <input type="text" v-model="item.name" placeholder="é …ç›®" class="w-1/3">
                        <input type="number" v-model.number="item.amount" placeholder="é‡‘é¡" class="w-1/3">
                        <select v-model="item.freq" class="w-1/4 text-xs">
                            <option :value="1">æ¯æœˆ</option>
                            <option :value="2">æ¯2æœˆ</option>
                            <option :value="12">æ¯å¹´</option>
                        </select>
                        <span class="btn-del" @click="removeRow(male.expenses, index)">âœ•</span>
                    </div>
                    <button class="btn-add" @click="addRow(male.expenses)">+ æ–°å¢é …ç›®</button>
                </div>
            </div>
            <div class="divider-bonus">
                <h3 class="font-bold text-blue-700 text-sm">ğŸ§§ å¹´åº¦çé‡‘ç¸½é¡</h3>
                <input type="number" v-model.number="male.bonusAmount" class="w-full mt-2 p-2 font-bold text-blue-700 bg-blue-50 border border-blue-200 rounded">
            </div>
        </div>

        <div class="card border-t-4 border-pink-500">
            <div class="section-header">
                <h2 class="text-xl font-bold text-pink-700">ğŸ‘© å¥³ç”Ÿè²¡å‹™</h2>
            </div>
            <div class="space-y-4 mb-4">
                <div><label class="block text-sm font-bold text-gray-600">æœˆè–ªè³‡</label><input type="number" v-model.number="female.salary" class="w-full"></div>
                <div><label class="block text-sm font-bold text-gray-600">æ’¥å…¥å…±åŒå¸³æˆ¶</label><input type="number" v-model.number="female.contrib" class="w-full bg-pink-50"></div>
                <div>
                    <h3 class="font-bold text-gray-600 text-sm mb-2">å€‹äººé–‹éŠ·ç´°é …</h3>
                    <div v-for="(item, index) in female.expenses" :key="index" class="input-row">
                        <input type="text" v-model="item.name" placeholder="é …ç›®" class="w-1/3">
                        <input type="number" v-model.number="item.amount" placeholder="é‡‘é¡" class="w-1/3">
                        <select v-model="item.freq" class="w-1/4 text-xs">
                            <option :value="1">æ¯æœˆ</option>
                            <option :value="2">æ¯2æœˆ</option>
                            <option :value="12">æ¯å¹´</option>
                        </select>
                        <span class="btn-del" @click="removeRow(female.expenses, index)">âœ•</span>
                    </div>
                    <button class="btn-add" @click="addRow(female.expenses)">+ æ–°å¢é …ç›®</button>
                </div>
            </div>
            <div class="divider-bonus">
                <h3 class="font-bold text-pink-700 text-sm">ğŸ§§ å¹´åº¦çé‡‘ç¸½é¡</h3>
                <input type="number" v-model.number="female.bonusAmount" class="w-full mt-2 p-2 font-bold text-pink-700 bg-pink-50 border border-pink-200 rounded">
            </div>
        </div>

        <div class="card border-t-4 border-green-500">
            <div class="section-header">
                <h2 class="text-xl font-bold text-green-700">ğŸ  å…±åŒå¸³æˆ¶</h2>
            </div>
            <div class="space-y-2 flex-grow">
                <div v-for="(item, index) in joint.expenses" :key="index" class="input-row">
                    <input type="text" v-model="item.name" placeholder="é …ç›®" class="w-1/3">
                    <input type="number" v-model.number="item.amount" placeholder="é‡‘é¡" class="w-1/3">
                    <select v-model="item.freq" class="w-1/4 text-xs"><option :value="1">æ¯æœˆ</option><option :value="2">æ¯2æœˆ</option><option :value="12">æ¯å¹´</option></select>
                    <span class="btn-del" @click="removeRow(joint.expenses, index)">âœ•</span>
                </div>
                <button class="btn-add" @click="addRow(joint.expenses)">+ æ–°å¢å…±åŒé–‹éŠ·</button>
            </div>
            <div class="mt-4 p-3 bg-green-100 rounded border border-green-200">
                <div class="flex justify-between items-end">
                    <div class="text-sm text-green-800 font-bold">å…±åŒç›ˆé¤˜</div>
                    <div :class="jointSurplus >= 0 ? 'text-green-700' : 'text-red-600'" class="text-2xl font-bold">{{ formatMoney(jointSurplus) }} <span class="text-xs">/æœˆ</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
        <div class="card bg-slate-800 text-white">
            <h2 class="text-2xl font-bold text-yellow-400 mb-6">ğŸ’° å…¨å¹´åº¦è³‡é‡‘çµç®—</h2>
            <div class="space-y-4">
                <div class="flex justify-between border-b border-slate-600 pb-2">
                    <span>12å€‹æœˆè–ªè³‡çµé¤˜</span>
                    <span class="font-mono text-xl">{{ formatMoney(totalMonthlySurplusYearly) }}</span>
                </div>
                <div class="flex justify-between border-b border-slate-600 pb-2">
                    <span>å¹´åº¦çé‡‘ç¸½é¡</span>
                    <span class="font-mono text-xl">{{ formatMoney(totalBonusYearly) }}</span>
                </div>
                <div class="flex justify-between items-center pt-4">
                    <span class="text-xl font-bold text-green-400">ğŸš€ å¹´åº¦å¯æŠ•è³‡ç¸½é¡</span>
                    <span class="text-4xl font-bold text-green-400">{{ formatMoney(totalInvestable) }}</span>
                </div>
            </div>
        </div>
        <div class="card">
            <h3 class="font-bold text-gray-700 mb-4 text-center">æ¯æœˆè³‡é‡‘æµå‘ä¼°ç®—</h3>
            <div class="h-64"><canvas id="financeChart"></canvas></div>
        </div>
    </div>

    <div class="card border-t-8 border-yellow-400 bg-yellow-50/30">
        <div class="section-header">
            <h2 class="text-2xl font-bold text-slate-800">ğŸ“ˆ è²¡å¯Œæˆé•·æ›²ç·š</h2>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 bg-white p-4 rounded-lg shadow-sm">
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å¹´æŠ•å…¥é‡‘</label><input type="number" v-model.number="etf.annualAmount" class="w-full font-bold"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">å ±é…¬ç‡ (%)</label><input type="number" v-model.number="etf.rate" class="w-full font-bold"></div>
                    <div><label class="block text-xs font-bold text-gray-500 mb-1">è©¦ç®—å¹´é™</label><input type="number" v-model.number="etf.years" class="w-full font-bold"></div>
                </div>
                <div class="h-80 bg-white p-4 rounded-lg border border-gray-200 shadow-inner">
                    <canvas id="etfChart"></canvas>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-sm border overflow-hidden flex flex-col h-[480px]">
                <div class="p-3 bg-slate-100 border-b font-bold text-center">è³‡ç”¢æˆé•·æ˜ç´°</div>
                <div class="overflow-y-auto flex-grow">
                    <table class="etf-table">
                        <thead><tr><th>å¹´åº¦</th><th>æœ¬é‡‘</th><th>å¢å€¼</th><th>ç¸½è³‡ç”¢</th></tr></thead>
                        <tbody>
                            <tr v-for="row in etfResult" :key="row.year">
                                <td class="text-center font-bold">{{ row.year }}</td>
                                <td>{{ formatMoney(row.principal) }}</td>
                                <td class="text-green-600">+{{ formatMoney(row.interest) }}</td>
                                <td class="font-bold bg-yellow-50">{{ formatMoney(row.total) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="saveToast" class="save-toast">âœ… è³‡æ–™å·²åŒæ­¥å„²å­˜è‡³ç€è¦½å™¨</div>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted } = Vue;

    createApp({
        setup() {
            const STORAGE_KEY = 'family_finance_v2_stable';

            // é è¨­è³‡æ–™
            const defaultData = {
                male: { salary: 60000, contrib: 30000, bonusAmount: 300000, expenses: [{ name: 'æ‰‹æ©Ÿè²»', amount: 999, freq: 1 }, { name: 'äº¤é€šè²»', amount: 3000, freq: 1 }] },
                female: { salary: 45000, contrib: 15000, bonusAmount: 180000, expenses: [{ name: 'ä¿é¤Šå“', amount: 2000, freq: 1 }] },
                joint: { expenses: [{ name: 'æˆ¿è²¸', amount: 25000, freq: 1 }, { name: 'ä¼™é£Ÿè²»', amount: 12000, freq: 1 }] },
                etf: { annualAmount: 0, rate: 7, years: 20 }
            };

            const male = ref(JSON.parse(JSON.stringify(defaultData.male)));
            const female = ref(JSON.parse(JSON.stringify(defaultData.female)));
            const joint = ref(JSON.parse(JSON.stringify(defaultData.joint)));
            const etf = ref(JSON.parse(JSON.stringify(defaultData.etf)));

            // æ ¸å¿ƒé‚è¼¯ï¼šè®€å–èˆ‡å„²å­˜
            const loadData = () => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const d = JSON.parse(saved);
                        male.value = d.male || male.value;
                        female.value = d.female || female.value;
                        joint.value = d.joint || joint.value;
                        etf.value = d.etf || etf.value;
                    } catch (e) { console.error("Load Error", e); }
                }
            };

            const showSaveToast = () => {
                const t = document.getElementById('saveToast');
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            };

            // è¨ˆç®—åŠŸèƒ½
            const calcTotalMonthly = (list) => list.reduce((sum, item) => sum + (Number(item.amount || 0) / (item.freq || 1)), 0);
            const formatMoney = (val) => Math.round(val || 0).toLocaleString();

            const jointSurplus = computed(() => (male.value.contrib + female.value.contrib) - calcTotalMonthly(joint.value.expenses));
            const mMonthlyLeft = computed(() => male.value.salary - male.value.contrib - calcTotalMonthly(male.value.expenses));
            const fMonthlyLeft = computed(() => female.value.salary - female.value.contrib - calcTotalMonthly(female.value.expenses));
            const totalMonthlySurplusYearly = computed(() => (mMonthlyLeft.value + fMonthlyLeft.value + jointSurplus.value) * 12);
            const totalBonusYearly = computed(() => (male.value.bonusAmount || 0) + (female.value.bonusAmount || 0));
            const totalInvestable = computed(() => totalMonthlySurplusYearly.value + totalBonusYearly.value);

            // ETF è©¦ç®—
            const etfResult = computed(() => {
                let res = [];
                let current = 0;
                let principal = 0;
                const r = etf.value.rate / 100;
                for(let i=1; i<=etf.value.years; i++){
                    principal += etf.value.annualAmount;
                    current = (current + etf.value.annualAmount) * (1 + r);
                    res.push({ year: i, principal, total: current, interest: current - principal });
                }
                return res;
            });

            // åœ–è¡¨å°è±¡
            let chart1 = null, chart2 = null;
            const updateCharts = () => {
                const ctx1 = document.getElementById('financeChart')?.getContext('2d');
                if(ctx1) {
                    if(chart1) chart1.destroy();
                    chart1 = new Chart(ctx1, {
                        type: 'doughnut',
                        data: {
                            labels: ['å…±åŒé–‹éŠ·', 'ç”·æ–¹å€‹äºº', 'å¥³æ–¹å€‹äºº', 'æŠ•è³‡æ½›åŠ›'],
                            datasets: [{
                                data: [calcTotalMonthly(joint.value.expenses), calcTotalMonthly(male.value.expenses), calcTotalMonthly(female.value.expenses), Math.max(0, totalInvestable.value/12)],
                                backgroundColor: ['#10b981', '#3b82f6', '#ec4899', '#f59e0b']
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }

                const ctx2 = document.getElementById('etfChart')?.getContext('2d');
                if(ctx2) {
                    if(chart2) chart2.destroy();
                    chart2 = new Chart(ctx2, {
                        type: 'line',
                        data: {
                            labels: etfResult.value.map(r => `Y${r.year}`),
                            datasets: [{ label: 'ç¸½è³‡ç”¢', data: etfResult.value.map(r => r.total), borderColor: '#ca8a04', fill: true, backgroundColor: 'rgba(202, 138, 4, 0.1)' }]
                        },
                        options: { responsive: true, maintainAspectRatio: false }
                    });
                }
            };

            // ç›£è½ä¸¦è‡ªå‹•å„²å­˜
            watch([male, female, joint, etf], () => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify({
                    male: male.value, female: female.value, joint: joint.value, etf: etf.value
                }));
                showSaveToast();
                updateCharts();
            }, { deep: true });

            // ç•¶å¹´åº¦æŠ•è³‡ç«åŠ›è®Šå‹•æ™‚ï¼Œè‡ªå‹•åŒæ­¥åˆ° ETF æŠ•å…¥é¡
            watch(totalInvestable, (nv) => { etf.value.annualAmount = Math.max(0, Math.round(nv)); });

            onMounted(() => {
                loadData();
                setTimeout(updateCharts, 500);
            });

            return {
                male, female, joint, etf, etfResult,
                jointSurplus, totalMonthlySurplusYearly, totalBonusYearly, totalInvestable,
                formatMoney,
                addRow: (list) => list.push({ name: '', amount: 0, freq: 1 }),
                removeRow: (list, idx) => list.splice(idx, 1),
                resetData: () => { if(confirm('é‡ç½®å¾Œè³‡æ–™ç„¡æ³•æ‰¾å›ï¼Œç¢ºå®šå—ï¼Ÿ')) { localStorage.removeItem(STORAGE_KEY); location.reload(); } }
            };
        }
    }).mount('#app');
</script>

</body>
</html>
