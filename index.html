<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>業務報價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 210mm;
      }
    }
  </style>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

/***********************************************************
 * P1 — 公司資料
 ***********************************************************/
const COMPANY_DATA = {
  herhsin: {
    name: "何鑫實業股份有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "薪昌股份有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

/***********************************************************
 * P1-1 — Google Sheet
 ***********************************************************/
const SPEC_SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?output=csv";

/***********************************************************
 * 報價單編號產生
 ***********************************************************/
const quoteSeqMap = {};
function generateQuoteNo(companyKey) {
  const p = COMPANY_DATA[companyKey].prefix;
  const d = new Date();
  const y = String(d.getFullYear()).slice(2);
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  const dateStr = `${y}${m}${day}`;
  const k = companyKey + dateStr;
  quoteSeqMap[k] = (quoteSeqMap[k] || 0) + 1;
  return `${p}${dateStr}-${String(quoteSeqMap[k]).padStart(2,"0")}`;
}

/***********************************************************
 * Google Sheet hook
 ***********************************************************/
function useSpecSheetData() {
  const [data, setData] = React.useState([]);
  React.useEffect(() => {
    fetch(SPEC_SHEET_URL)
      .then(r=>r.text())
      .then(csv=>{
        const rows = csv.trim().split("\n");
        const h = rows[0].split(",");
        setData(rows.slice(1).map(r=>{
          const c = r.split(",");
          const o = {};
          h.forEach((x,i)=>o[x.trim()] = (c[i]||"").trim());
          return o;
        }));
      });
  }, []);
  return data;
}

/***********************************************************
 * AppContext
 ***********************************************************/
const AppContext = React.createContext();
function AppProvider({children}) {
  const [activeQuote, setActiveQuote] = React.useState(null);
  const newQuote = (companyKey) => {
    setActiveQuote({
      id: Date.now(),
      companyKey,
      no: generateQuoteNo(companyKey),
      items: []
    });
  };
  return (
    <AppContext.Provider value={{activeQuote,setActiveQuote,newQuote}}>
      {children}
    </AppContext.Provider>
  );
}

/***********************************************************
 * Autocomplete
 ***********************************************************/
function SpecAutocomplete({item,onSelect}) {
  const data = useSpecSheetData();
  const [kw,setKw]=React.useState("");
  const list = React.useMemo(()=>{
    if(!kw) return [];
    return data.filter(r=>
      (r["品名"]||"").includes(kw) ||
      (r["規格"]||"").includes(kw)
    ).slice(0,10);
  },[kw,data]);

  return (
    <div className="relative">
      <input className="border p-2 w-full"
        placeholder="搜尋品名 / 規格"
        value={kw}
        onChange={e=>setKw(e.target.value)}
      />
      {list.length>0 && (
        <div className="absolute z-20 bg-white border w-full">
          {list.map((r,i)=>(
            <div key={i}
              className="p-2 hover:bg-gray-100 cursor-pointer"
              onClick={()=>{
                onSelect({
                  ...item,
                  name:r["品名"],
                  spec:r["規格"],
                  unit:r["單位"],
                  price:Number(r["單價"]||0),
                  material1:r["用料1"]||"",
                  material2:r["用料2"]||"",
                  material3:r["用料3"]||"",
                });
                setKw("");
              }}>
              <div className="font-medium">{r["品名"]}</div>
              <div className="text-xs text-gray-600">{r["規格"]}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

/***********************************************************
 * QuoteItem
 ***********************************************************/
function QuoteItem({item,onChange}) {
  return (
    <div className="border p-3 bg-white space-y-2">
      <SpecAutocomplete item={item} onSelect={onChange}/>
      <input className="border p-2 w-full" placeholder="品名"
        value={item.name||""}
        onChange={e=>onChange({...item,name:e.target.value})}/>
      <input className="border p-2 w-full" placeholder="規格"
        value={item.spec||""}
        onChange={e=>onChange({...item,spec:e.target.value})}/>
      <input className="border p-2 w-full" placeholder="單價"
        value={item.price||""}
        onChange={e=>onChange({...item,price:Number(e.target.value)})}/>
    </div>
  );
}

/***********************************************************
 * PrintLayout（正式）
 ***********************************************************/
function PrintLayout({quote}) {
  const c = COMPANY_DATA[quote.companyKey];
  return (
    <div id="print-area" className="p-8 bg-white text-sm"
      style={{width:"210mm",minHeight:"297mm"}}>
      <h1 className="text-xl font-bold text-center">{c.name}</h1>
      <div className="text-center mb-4">{c.address}</div>
      <div>報價單號：{quote.no}</div>

      <table className="w-full border mt-4">
        <thead>
          <tr>
            <th className="border">品名</th>
            <th className="border">規格</th>
            <th className="border">用料</th>
            <th className="border">金額</th>
          </tr>
        </thead>
        <tbody>
          {quote.items.map((i,idx)=>(
            <tr key={idx}>
              <td className="border">{i.name}</td>
              <td className="border">{i.spec}</td>
              <td className="border">
                {[i.material1,i.material2,i.material3].filter(Boolean).join("、")}
              </td>
              <td className="border text-right">{i.price}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="flex justify-between mt-16">
        <div className="border w-1/3 h-24 flex items-end p-2">客戶簽名</div>
        <div className="border w-1/3 h-24 flex items-center justify-center">
          <img src={c.stamp} className="max-h-20"/>
        </div>
      </div>
    </div>
  );
}

/***********************************************************
 * App
 ***********************************************************/
function App() {
  const {activeQuote,setActiveQuote,newQuote} = React.useContext(AppContext);
  const previewRef = React.useRef();

  return (
    <div className="flex min-h-screen">
      <div className="w-48 bg-white p-4 border-r">
        {Object.entries(COMPANY_DATA).map(([k,c])=>(
          <button key={k}
            className={`w-full mb-2 p-2 ${activeQuote?.companyKey===k?"bg-blue-600 text-white":"bg-gray-200"}`}
            onClick={()=>{
              if(!activeQuote) newQuote(k);
              else setActiveQuote({...activeQuote,companyKey:k,no:generateQuoteNo(k)});
            }}>
            {c.name}
          </button>
        ))}
      </div>

      <div className="flex-grow p-6">
        {activeQuote && (
          <>
            {activeQuote.items.map((it,idx)=>(
              <QuoteItem key={idx} item={it}
                onChange={v=>{
                  const items=[...activeQuote.items];
                  items[idx]=v;
                  setActiveQuote({...activeQuote,items});
                }}/>
            ))}
            <button className="bg-green-600 text-white px-3 py-1 mt-2"
              onClick={()=>setActiveQuote({...activeQuote,items:[...activeQuote.items,{}]})}>
              + 新增項目
            </button>

            <div className="mt-8" ref={previewRef}>
              <PrintLayout quote={activeQuote}/>
            </div>

            <button className="mt-4 bg-red-600 text-white px-3 py-1"
              onClick={()=>html2pdf().from(previewRef.current).save()}>
              PDF
            </button>
          </>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(
  <AppProvider><App/></AppProvider>
);

</script>
</body>
</html>
