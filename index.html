<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>業務報價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 210mm;
      }
    }
  </style>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

/* ================= 公司資料 ================= */
const COMPANY_DATA = {
  herhsin: {
    name: "何鑫實業股份有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "薪昌股份有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

/* ================= Google Sheet ================= */
const SPEC_SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?output=csv";

/* ================= 報價單編號 ================= */
const seqMap = {};
function generateQuoteNo(companyKey) {
  const d = new Date();
  const yy = String(d.getFullYear()).slice(2);
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  const date = `${yy}${mm}${dd}`;
  const k = companyKey + date;
  seqMap[k] = (seqMap[k] || 0) + 1;
  return `${COMPANY_DATA[companyKey].prefix}${date}-${String(seqMap[k]).padStart(2,"0")}`;
}

/* ================= Google Sheet Hook ================= */
function useSpecSheetData() {
  const [data, setData] = React.useState([]);
  React.useEffect(() => {
    fetch(SPEC_SHEET_URL)
      .then(r=>r.text())
      .then(csv=>{
        const rows = csv.trim().split("\n");
        const h = rows[0].split(",");
        setData(rows.slice(1).map(r=>{
          const c = r.split(",");
          const o = {};
          h.forEach((x,i)=>o[x.trim()] = (c[i]||"").trim());
          return o;
        }));
      });
  }, []);
  return data;
}

/* ================= Context ================= */
const AppContext = React.createContext();
function AppProvider({children}) {
  const [activeQuote, setActiveQuote] = React.useState(null);
  const newQuote = (companyKey) => {
    setActiveQuote({
      companyKey,
      no: generateQuoteNo(companyKey),
      date: new Date().toLocaleDateString(),
      projectName:"",
      customerName:"",
      contactPerson:"",
      contactTel:"",
      contactAddr:"",
      sales:"",
      stage:"",
      contractNo:"",
      taxId:"",
      fax:"",
      items:[]
    });
  };
  return (
    <AppContext.Provider value={{activeQuote,setActiveQuote,newQuote}}>
      {children}
    </AppContext.Provider>
  );
}

/* ================= Autocomplete ================= */
function SpecAutocomplete({item,onSelect}) {
  const data = useSpecSheetData();
  const [kw,setKw] = React.useState("");
  const list = React.useMemo(()=>{
    if(!kw) return [];
    return data.filter(r =>
      (r["品名"]||"").includes(kw) ||
      (r["規格"]||"").includes(kw)
    ).slice(0,8);
  },[kw,data]);

  return (
    <div className="relative">
      <input className="border p-1 w-full"
        placeholder="品名 / 規格"
        value={kw}
        onChange={e=>setKw(e.target.value)}
      />
      {list.length>0 && (
        <div className="absolute z-20 bg-white border w-full">
          {list.map((r,i)=>(
            <div key={i}
              className="p-1 hover:bg-gray-100 cursor-pointer"
              onClick={()=>{
                onSelect({
                  ...item,
                  name:r["品名"],
                  spec:r["規格"],
                  unit:r["單位"],
                  price:Number(r["單價"]||0),
                  material1:r["用料1"]||"",
                  material2:r["用料2"]||"",
                  material3:r["用料3"]||"",
                  qty:1,
                  remark:""
                });
                setKw("");
              }}>
              <div className="font-medium">{r["品名"]}</div>
              <div className="text-xs text-gray-600">{r["規格"]}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

/* ================= QuoteItem（含圖片 / 刪除） ================= */
function QuoteItem({item,index,onChange,onDelete}) {
  const subtotal = (item.qty||0)*(item.price||0);

  const handleImage = (file) => {
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      onChange({...item,imageData:reader.result});
    };
    reader.readAsDataURL(file);
  };

  return (
    <>
      <tr>
        <td className="border text-center">{index+1}</td>
        <td className="border p-1">
          <SpecAutocomplete item={item} onSelect={onChange}/>
          <div>{item.name}</div>
        </td>
        <td className="border p-1">{item.spec}</td>
        <td className="border p-1">{item.unit}</td>
        <td className="border p-1">
          <input type="number" className="w-full"
            value={item.qty||""}
            onChange={e=>onChange({...item,qty:Number(e.target.value)})}/>
        </td>
        <td className="border p-1">
          <input type="number" className="w-full"
            value={item.price||""}
            onChange={e=>onChange({...item,price:Number(e.target.value)})}/>
        </td>
        <td className="border p-1 text-right">{subtotal}</td>
        <td className="border p-1">
          <input className="w-full"
            value={item.remark||""}
            onChange={e=>onChange({...item,remark:e.target.value})}/>
        </td>
        <td className="border text-center">
          <button className="text-red-600" onClick={onDelete}>刪除</button>
        </td>
      </tr>

      {(item.material1||item.material2||item.material3) && (
        <tr>
          <td></td>
          <td colSpan="8" className="text-sm text-gray-600 pl-4">
            {index+1}-1 用料明細：
            {[item.material1,item.material2,item.material3].filter(Boolean).join("、")}
          </td>
        </tr>
      )}

      {item.imageData && (
        <tr>
          <td></td>
          <td colSpan="8" className="pl-4">
            <img src={item.imageData} className="max-h-32"/>
          </td>
        </tr>
      )}

      <tr>
        <td></td>
        <td colSpan="8" className="pl-4">
          <input type="file" accept="image/*"
            onChange={e=>handleImage(e.target.files[0])}/>
        </td>
      </tr>
    </>
  );
}

/* ================= PrintLayout ================= */
function PrintLayout({quote}) {
  const c = COMPANY_DATA[quote.companyKey];
  return (
    <div id="print-area" className="p-8 bg-white text-sm"
      style={{width:"210mm",minHeight:"297mm"}}>
      <h1 className="text-xl font-bold text-center">{c.name}</h1>
      <div className="text-center mb-2">{c.address}</div>

      <div className="grid grid-cols-2 gap-2 mb-4">
        <div>
          報價單號：{quote.no}<br/>
          報價日期：{quote.date}<br/>
          客戶名稱：{quote.customerName}<br/>
          工程名稱：{quote.projectName}<br/>
          主辦人：{quote.contactPerson}<br/>
          聯絡電話：{quote.contactTel}<br/>
          聯絡地址：{quote.contactAddr}
        </div>
        <div>
          接單人員：{quote.sales}<br/>
          報價階段：{quote.stage}<br/>
          合約案號：{quote.contractNo}<br/>
          客戶統編：{quote.taxId}<br/>
          傳真號碼：{quote.fax}
        </div>
      </div>

      <table className="w-full border-collapse border">
        <thead>
          <tr>
            <th className="border">項次</th>
            <th className="border">品名</th>
            <th className="border">規格</th>
            <th className="border">單位</th>
            <th className="border">數量</th>
            <th className="border">單價</th>
            <th className="border">小計</th>
            <th className="border">備註</th>
          </tr>
        </thead>
        <tbody>
          {quote.items.map((i,idx)=>(
            <React.Fragment key={idx}>
              <tr>
                <td className="border text-center">{idx+1}</td>
                <td className="border">{i.name}</td>
                <td className="border">{i.spec}</td>
                <td className="border">{i.unit}</td>
                <td className="border text-right">{i.qty}</td>
                <td className="border text-right">{i.price}</td>
                <td className="border text-right">{(i.qty||0)*(i.price||0)}</td>
                <td className="border">{i.remark}</td>
              </tr>

              {(i.material1||i.material2||i.material3) && (
                <tr>
                  <td></td>
                  <td colSpan="7" className="text-xs pl-4">
                    {idx+1}-1 用料明細：
                    {[i.material1,i.material2,i.material3].filter(Boolean).join("、")}
                  </td>
                </tr>
              )}

              {i.imageData && (
                <tr>
                  <td></td>
                  <td colSpan="7" className="pl-4">
                    <img src={i.imageData} className="max-h-32"/>
                  </td>
                </tr>
              )}
            </React.Fragment>
          ))}
        </tbody>
      </table>

      <div className="flex justify-between mt-16">
        <div className="border w-1/3 h-24 p-2">客戶簽名</div>
        <div className="border w-1/3 h-24 flex items-center justify-center">
          <img src={c.stamp} className="max-h-20"/>
        </div>
      </div>
    </div>
  );
}

/* ================= App ================= */
function App() {
  const {activeQuote,setActiveQuote,newQuote} = React.useContext(AppContext);
  const previewRef = React.useRef();

  return (
    <div className="flex min-h-screen">
      <div className="w-44 bg-white p-3 border-r">
        {Object.entries(COMPANY_DATA).map(([k,c])=>(
          <button key={k}
            className={`w-full mb-2 p-2 ${activeQuote?.companyKey===k?"bg-blue-600 text-white":"bg-gray-200"}`}
            onClick={()=>{
              if(!activeQuote) newQuote(k);
              else setActiveQuote({...activeQuote,companyKey:k,no:generateQuoteNo(k)});
            }}>
            {c.name}
          </button>
        ))}
      </div>

      <div className="flex-grow p-4">
        {activeQuote && (
          <>
            <table className="w-full border mb-2">
              <tbody>
                {activeQuote.items.map((it,idx)=>(
                  <QuoteItem key={idx} index={idx} item={it}
                    onChange={v=>{
                      const items=[...activeQuote.items];
                      items[idx]=v;
                      setActiveQuote({...activeQuote,items});
                    }}
                    onDelete={()=>{
                      const items=activeQuote.items.filter((_,i)=>i!==idx);
                      setActiveQuote({...activeQuote,items});
                    }}
                  />
                ))}
              </tbody>
            </table>

            <button className="bg-green-600 text-white px-3 py-1"
              onClick={()=>setActiveQuote({...activeQuote,items:[...activeQuote.items,{}]})}>
              + 新增品項
            </button>

            <div ref={previewRef} className="mt-8">
              <PrintLayout quote={activeQuote}/>
            </div>

            <button className="bg-red-600 text-white px-3 py-1 mt-2"
              onClick={()=>html2pdf().from(previewRef.current).save()}>
              PDF
            </button>
          </>
        )}
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(
  <AppProvider><App/></AppProvider>
);

</script>
</body>
</html>
