<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>業務報價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React 18 -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

  <!-- Babel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- PDF / Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <style>
    @media print {
      body * { visibility: hidden; }
      #print-area, #print-area * { visibility: visible; }
      #print-area { position: absolute; inset: 0; }
    }
  </style>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">

/***********************************************************
 * P1-0 — COMPANY_DATA
 ***********************************************************/
const COMPANY_DATA = {
  herhsin: {
    name: "何鑫實業股份有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/herhsin_stamp.JPG",
    prefix: "QH",
  },
  sinchang: {
    name: "薪昌股份有限公司",
    tel: "07-6521927",
    fax: "07-6517994",
    email: "affairs@herhsin.com",
    address: "831高雄市大寮區鳳屏二路383-8號",
    stamp: "https://amy262631-ui.github.io/Quotation/sinchang_stamp.JPG",
    prefix: "QS",
  },
};

/***********************************************************
 * P1-1 — Google Sheet
 ***********************************************************/
const SPEC_SHEET_URL =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHQN_nMBB7l72PSD8omOO55UYRlIClUGEDgtzYzTKK-5fvRWIZowcdnMHvkkwJbdz7krhIiRc00sye/pub?output=csv";

/***********************************************************
 * P1-2 — useSpecSheetData
 ***********************************************************/
function useSpecSheetData() {
  const [data, setData] = React.useState([]);

  React.useEffect(() => {
    fetch(SPEC_SHEET_URL)
      .then(r => r.text())
      .then(csv => {
        const rows = csv.trim().split("\n");
        const headers = rows[0].split(",");
        const parsed = rows.slice(1).map(r => {
          const cols = r.split(",");
          const o = {};
          headers.forEach((h, i) => o[h.trim()] = (cols[i] || "").trim());
          return o;
        });
        setData(parsed);
      });
  }, []);

  return data;
}

/***********************************************************
 * P2 — 計算函式（純 function）
 ***********************************************************/
function calcTotal(items = []) {
  return items.reduce((s, i) => s + (Number(i.price) || 0), 0);
}

function calcNegotiated(total, percent, amount) {
  if (amount) return total - Number(amount);
  if (percent) return total * (1 - percent / 100);
  return total;
}

/***********************************************************
 * P3 — AppContext（activeQuote）
 ***********************************************************/
const AppContext = React.createContext();

function AppProvider({ children }) {
  const [activeQuote, setActiveQuote] = React.useState(null);

  const newQuote = (companyKey) => {
    const today = new Date();
    const dateStr = today.toISOString().slice(0,10).replace(/-/g,"");
    const q = {
      id: Date.now(),
      companyKey,
      no: `${COMPANY_DATA[companyKey].prefix}-${dateStr}-001`,
      items: [],
      discountPercent: "",
      negotiatedPrice: ""
    };
    setActiveQuote(q);
  };

  return (
    <AppContext.Provider value={{ activeQuote, setActiveQuote, newQuote }}>
      {children}
    </AppContext.Provider>
  );
}

/***********************************************************
 * P4 — Autocomplete
 ***********************************************************/
function SpecAutocomplete({ value, onSelect }) {
  const specData = useSpecSheetData();
  const [kw, setKw] = React.useState("");
  const list = React.useMemo(() => {
    if (!kw) return [];
    return specData.filter(r =>
      (r["品名"]||"").includes(kw) || (r["規格"]||"").includes(kw)
    ).slice(0,8);
  }, [kw, specData]);

  return (
    <div className="relative">
      <input className="border p-2 w-full"
        placeholder="搜尋品名 / 規格"
        value={kw}
        onChange={e=>setKw(e.target.value)}
      />
      {list.length>0 && (
        <div className="absolute bg-white border w-full z-10">
          {list.map((r,i)=>(
            <div key={i}
              className="p-2 hover:bg-gray-100 cursor-pointer"
              onClick={()=>{
                onSelect({
                  ...value,
                  name: r["品名"],
                  spec: r["規格"],
                  unit: r["單位"],
                  price: Number(r["單價"]||0),
                  m1: r["用料1"]||"",
                  m2: r["用料2"]||"",
                  m3: r["用料3"]||"",
                });
                setKw("");
              }}>
              <div className="font-medium">{r["品名"]}</div>
              <div className="text-xs">{r["規格"]}</div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

/***********************************************************
 * P5 — QuoteItem
 ***********************************************************/
function QuoteItem({ item, onChange }) {
  return (
    <div className="border p-3 bg-white space-y-2">
      <SpecAutocomplete value={item} onSelect={onChange} />
      <input className="border p-2 w-full" placeholder="品名"
        value={item.name||""}
        onChange={e=>onChange({...item,name:e.target.value})}/>
      <input className="border p-2 w-full" placeholder="規格"
        value={item.spec||""}
        onChange={e=>onChange({...item,spec:e.target.value})}/>
      <input className="border p-2 w-full" placeholder="單價"
        value={item.price||""}
        onChange={e=>onChange({...item,price:e.target.value})}/>
    </div>
  );
}

/***********************************************************
 * P6 — PrintLayout（只顯示）
 ***********************************************************/
function PrintLayout({ quote, total, final }) {
  const c = COMPANY_DATA[quote.companyKey];
  return (
    <div id="print-area" className="p-6 bg-white text-sm">
      <h1 className="text-xl font-bold">{c.name}</h1>
      <div>{c.address}</div>

      <table className="w-full border mt-4">
        <thead>
          <tr>
            <th className="border">品名</th>
            <th className="border">規格</th>
            <th className="border">用料</th>
            <th className="border">金額</th>
          </tr>
        </thead>
        <tbody>
          {quote.items.map((i,idx)=>(
            <tr key={idx}>
              <td className="border">{i.name}</td>
              <td className="border">{i.spec}</td>
              <td className="border">
                {[i.m1,i.m2,i.m3].filter(Boolean).join("、")}
              </td>
              <td className="border text-right">{i.price}</td>
            </tr>
          ))}
        </tbody>
      </table>

      <div className="text-right mt-4">總價：{total}</div>
      <div className="text-right font-bold">最終總價：{Math.round(final)}</div>

      <div className="flex justify-between mt-12">
        <div className="border-t w-1/3">客戶簽名</div>
        <img src={c.stamp} className="h-20"/>
      </div>
    </div>
  );
}

/***********************************************************
 * P7 — App
 ***********************************************************/
function App() {
  const { activeQuote, setActiveQuote, newQuote } = React.useContext(AppContext);
  const total = React.useMemo(()=>activeQuote?calcTotal(activeQuote.items):0,[activeQuote]);
  const final = React.useMemo(()=>activeQuote?calcNegotiated(total,activeQuote.discountPercent,activeQuote.negotiatedPrice):0,[activeQuote,total]);
  const ref = React.useRef();

  return (
    <div className="p-6 max-w-5xl mx-auto space-y-4">
      {!activeQuote && (
        Object.entries(COMPANY_DATA).map(([k,c])=>(
          <button key={k} className="px-4 py-2 bg-blue-600 text-white mr-2"
            onClick={()=>newQuote(k)}>
            新增 {c.name}
          </button>
        ))
      )}

      {activeQuote && (
        <>
          {activeQuote.items.map((it,idx)=>(
            <QuoteItem key={idx} item={it}
              onChange={v=>{
                const items=[...activeQuote.items];
                items[idx]=v;
                setActiveQuote({...activeQuote,items});
              }}/>
          ))}
          <button className="bg-green-600 text-white px-3 py-1"
            onClick={()=>setActiveQuote({...activeQuote,items:[...activeQuote.items,{}]})}>
            + 新增項目
          </button>

          <div className="flex gap-2 mt-4">
            <button onClick={()=>window.print()} className="bg-gray-700 text-white px-3 py-1">列印</button>
            <button onClick={()=>html2pdf().from(ref.current).save()} className="bg-red-600 text-white px-3 py-1">PDF</button>
          </div>

          <div ref={ref} className="mt-4">
            <PrintLayout quote={activeQuote} total={total} final={final}/>
          </div>
        </>
      )}
    </div>
  );
}

/***********************************************************
 * P8 — ReactDOM.createRoot
 ***********************************************************/
ReactDOM.createRoot(document.getElementById("root")).render(
  <AppProvider><App/></AppProvider>
);

</script>
</body>
</html>
